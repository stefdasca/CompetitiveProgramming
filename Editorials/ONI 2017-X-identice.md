
We will study separately the case for the value 0 and separately for the value 1.  
We will analyze the calculation method for the number of submatrices $K$ that contain only one value.  
For example, let $s[i][j]$ be a sequence of 0s on row $i$, with maximum length that ends at column $j$. Then the number of submatrices that contain only 0, with the bottom-right corner at row $i$, column $j$, will be $s[i][j] + \min(s[i][j], s[i-1][j]) + \dots + \min(s[i][j], s[i-1][j], \dots, s[1][j])$. So, we sum over the height from 1 to $j$. Such an implementation has a complexity of $O(N^3)$ and achieves 10-20 points.  
A complexity of $O(N^2)$ can be obtained by iterating over the elements column by column and maintaining a stack ordered in increasing order with the elements from $s$, and for each element, we associate the number of terms from the previous sum for which it is the minimum. When inserting $s[i][j]$ into the stack, we remove all larger elements and will add to the associated count the numbers associated with the removed elements. We will always add to the result the product of the elements in the stack and the values associated with them.  

To calculate the value $R$, it is observed that a brute-force approach can be done in $O(N^4)$, noticing that when we reach a value 1 (and we want to obtain 0), we are at the top-left of a square and we apply ZET if possible; otherwise, we have no solution. The method is optimized by calculating in $O(1)$ for each element the number of changes, something which can be done using 2D Difference Arrays to optimize the ZET operation or by using $N$ queues for rows and another $N$ queues for columns. We check the parity of the sum of the queue sizes for each element based on the position. If we obtain 1, it changes to 0, and the position is stored in sorted queues. If the difference between the first index and the current one exceeds $D$, the element is removed from the queue. If the ZET operation needs to be applied in the current position but there is no space (submatrix of side $D$), then we have no solution, so $R = -1$.  
